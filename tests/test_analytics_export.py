#!/usr/bin/env python3
"""
–¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á–µ—Ç–æ–≤ –≤ Excel
"""

import asyncio
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—è–º
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from core.database import db_manager
from managers.export_manager import ExportManager

async def test_analytics_export():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á–µ—Ç–æ–≤ –≤ Excel"""
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä —ç–∫—Å–ø–æ—Ä—Ç–∞
    export_manager = ExportManager(db_manager)
    
    print("üìä –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –≠–ö–°–ü–û–†–¢–ê –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–• –û–¢–ß–ï–¢–û–í –í EXCEL")
    print("=" * 60)
    
    # –¢–µ—Å—Ç–æ–≤—ã–π chat_id
    test_chat_id = 12345
    
    try:
        # –¢–µ—Å—Ç 1: –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç
        print("\nüìÑ –¢–µ—Å—Ç 1: –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç")
        full_report = await export_manager.export_analytics_report(test_chat_id, "full")
        print(f"‚úÖ –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω")
        print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(full_report.getvalue())} –±–∞–π—Ç")
        
        # –¢–µ—Å—Ç 2: –û—Ç—á–µ—Ç –ø–æ —Ç—Ä–µ–Ω–¥–∞–º
        print("\nüìà –¢–µ—Å—Ç 2: –û—Ç—á–µ—Ç –ø–æ —Ç—Ä–µ–Ω–¥–∞–º")
        trends_report = await export_manager.export_analytics_report(test_chat_id, "trends")
        print(f"‚úÖ –û—Ç—á–µ—Ç –ø–æ —Ç—Ä–µ–Ω–¥–∞–º —Å–æ–∑–¥–∞–Ω")
        print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(trends_report.getvalue())} –±–∞–π—Ç")
        
        # –¢–µ—Å—Ç 3: –û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–≥–Ω–æ–∑–∞–º
        print("\nüéØ –¢–µ—Å—Ç 3: –û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–≥–Ω–æ–∑–∞–º")
        forecast_report = await export_manager.export_analytics_report(test_chat_id, "forecast")
        print(f"‚úÖ –û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–≥–Ω–æ–∑–∞–º —Å–æ–∑–¥–∞–Ω")
        print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(forecast_report.getvalue())} –±–∞–π—Ç")
        
        # –¢–µ—Å—Ç 4: –û—Ç—á–µ—Ç –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        print("\n‚ö° –¢–µ—Å—Ç 4: –û—Ç—á–µ—Ç –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏")
        efficiency_report = await export_manager.export_analytics_report(test_chat_id, "efficiency")
        print(f"‚úÖ –û—Ç—á–µ—Ç –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω")
        print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(efficiency_report.getvalue())} –±–∞–π—Ç")
        
        # –¢–µ—Å—Ç 5: –≠–∫—Å–ø–æ—Ä—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á–µ—Ç–æ–≤
        print("\nüìã –¢–µ—Å—Ç 5: –≠–∫—Å–ø–æ—Ä—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á–µ—Ç–æ–≤")
        
        # –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç
        daily_excel = await export_manager.export_automated_report(test_chat_id, "daily")
        if daily_excel:
            print(f"‚úÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –≤ Excel —Å–æ–∑–¥–∞–Ω")
            print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(daily_excel.getvalue())} –±–∞–π—Ç")
        else:
            print("üìä –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –ø—É—Å—Ç (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)")
        
        # –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
        weekly_excel = await export_manager.export_automated_report(test_chat_id, "weekly")
        if weekly_excel:
            print(f"‚úÖ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –≤ Excel —Å–æ–∑–¥–∞–Ω")
            print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(weekly_excel.getvalue())} –±–∞–π—Ç")
        else:
            print("üìä –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø—É—Å—Ç (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)")
        
        # –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç
        monthly_excel = await export_manager.export_automated_report(test_chat_id, "monthly")
        if monthly_excel:
            print(f"‚úÖ –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç –≤ Excel —Å–æ–∑–¥–∞–Ω")
            print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(monthly_excel.getvalue())} –±–∞–π—Ç")
        else:
            print("üìä –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç –ø—É—Å—Ç (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)")
        
        # –¢–µ—Å—Ç 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Excel —Ñ–∞–π–ª–æ–≤
        print("\nüîç –¢–µ—Å—Ç 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Excel —Ñ–∞–π–ª–æ–≤")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        test_file_path = "/tmp/test_analytics_report.xlsx"
        with open(test_file_path, "wb") as f:
            f.write(full_report.getvalue())
        print(f"‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {test_file_path}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
        if os.path.exists(test_file_path):
            file_size = os.path.getsize(test_file_path)
            print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–∞ –¥–∏—Å–∫–µ: {file_size} –±–∞–π—Ç")
            
            # –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
            os.remove(test_file_path)
            print("üóëÔ∏è –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω")
        
        print("\nüéâ –í–°–ï –¢–ï–°–¢–´ –≠–ö–°–ü–û–†–¢–ê –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–• –û–¢–ß–ï–¢–û–í –ü–†–û–ô–î–ï–ù–´!")
        print("\nüìù –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤–∫–ª—é—á–∞–µ—Ç:")
        print("  ‚úÖ –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ª–∏—Å—Ç–∞–º–∏")
        print("  ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π")
        print("  ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –Ω–∞–≥—Ä—É–∑–∫–∏ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏")
        print("  ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏")
        print("  ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º —Å —Ç–µ–∫—Å—Ç–æ–≤–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π")
        print("  ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è —Å –æ—Ü–µ–Ω–∫–æ–π —Ä–∏—Å–∫–æ–≤")
        print("  ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á–µ—Ç–æ–≤ –≤ Excel —Ñ–æ—Ä–º–∞—Ç")
        print("  ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Excel —Ñ–∞–π–ª–æ–≤")
        print("  ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞–µ–≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–∞–Ω–Ω—ã—Ö")
        print("  ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –º–æ–¥—É–ª—è–º–∏")
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        print("\nüìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞:")
        print("  üìä –õ–∏—Å—Ç '–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤' - –¥–∏–Ω–∞–º–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π –∑–∞ 6 –º–µ—Å—è—Ü–µ–≤")
        print("  üéØ –õ–∏—Å—Ç '–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞–≥—Ä—É–∑–∫–∏' - –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 30 –¥–Ω–µ–π —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π")
        print("  ‚ö° –õ–∏—Å—Ç '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å' - –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏—è —Å—Ä–æ–∫–æ–≤")
        print("  üìÖ –õ–∏—Å—Ç '–í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã' - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º")
        print("  üîÆ –õ–∏—Å—Ç '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑' - –º–Ω–æ–≥–æ–ø–µ—Ä–∏–æ–¥–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤")
        print("  üíº –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ü–≤–µ—Ç–æ–≤—ã–º –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–æ–≤")
        print("  üìê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫")
        print("  üé® –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤")
        
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")
        import traceback
        traceback.print_exc()
        return False

async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    success = await test_analytics_export()
    return success

if __name__ == "__main__":
    success = asyncio.run(main())
    sys.exit(0 if success else 1)